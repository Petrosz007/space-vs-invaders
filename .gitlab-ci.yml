image: andipeter/monogame-test:0.4

stages:
    - build
    - test
    - generate-docs
    - deploy

build:
    stage: build
    script:
        - dotnet build src/SpaceVsInvaders/

test:
    stage: test
    script:
        - dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=./lcov.info src/SpaceVsInvaders.Tests/
        - reportgenerator "-reports:src/SpaceVsInvaders.Tests/lcov.info" "-targetdir:coveragereport" -reporttypes:Html
    artifacts:
        paths:
            - coveragereport

generate-docs:
    stage: generate-docs
    script:
        - mono /opt/docfx/docfx.exe $PWD/docs/webdocs/docfx.json
        - mono /opt/docfx/docfx.exe build $PWD/docs/webdocs/docfx.json
    artifacts:
        paths:
            - docs/webdocs/_site

pages:
    stage: deploy
    image: node:lts-stretch-slim
    script:
        - mkdir -p public/coveragereport/
        - mkdir -p public/docs/
        - cp -r coveragereport/ public/coveragereport/
        - cp -r docs/webdocs/_site/ public/docs/
        - npm i -g netlify-cli 
        - npx netlify-cli deploy --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --prod
    needs:
        - job: test
          artifacts: true
        - job: generate-docs
          artifacts: true
    artifacts:
        paths:
            - public
    
